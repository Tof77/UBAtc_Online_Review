<!DOCTYPE html>
<html>
<head>
  <title>Relecture PDF - Multi Pages</title>
  <style>
    body { display: flex; margin: 0; height: 100vh; }
    #viewerContainer { flex: 3; overflow: auto; position: relative; background: #f0f0f0; }
    #commentsPanel { flex: 1; border-left: 2px solid #ccc; padding: 10px; overflow-y: auto; background: #fafafa; }
    #commentsPanel h2 { font-size: 18px; margin-top: 0; }
    .comment { margin-bottom: 10px; background: #fff; padding: 5px; border-radius: 5px; }
    .suggestion { border-left: 5px solid #42a5f5; }
    .question { border-left: 5px solid #1e88e5; }
    .error { border-left: 5px solid #e53935; }
    .info { border-left: 5px solid #43a047; }
    .other { border-left: 5px solid #9e9e9e; }
    .reply { margin-left: 20px; font-size: 90%; background: #eef; border-radius: 3px; padding: 3px; }
    canvas { border: 1px solid #ccc; margin-bottom: 10px; }
    .controls { text-align: center; margin: 10px; }
    .modal {
      display: none; position: fixed; top: 30%; left: 50%;
      transform: translate(-50%, -30%);
      background: white; border: 2px solid #000; padding: 20px; z-index: 10;
    }
    .modal input, .modal select { margin: 5px 0; }
  </style>
  <script src="/static/pdfjs/pdf.min.js"></script>
</head>
<body>
  <div id="viewerContainer">
    <div class="controls">
      <button onclick="prevPage()">⬅️ Précédent</button>
      <span>Page: <span id="page_num">1</span> / <span id="page_count">?</span></span>
      <button onclick="nextPage()">Suivant ➡️</button>
    </div>
    <canvas id="pdf-canvas" onclick="handleClick(event)"></canvas>
  </div>

  <div id="commentsPanel">
    <h2>Commentaires</h2>
    <div id="commentsList"></div>
  </div>

<!-- Modale pour ajouter un commentaire -->
<div id="commentModal" class="modal">
  <h3>Ajouter un commentaire</h3>
  <textarea id="commentText" placeholder="Votre commentaire" rows="4" cols="40"></textarea><br>
  <select id="commentType">
    <option value="suggestion">Suggestion</option>
    <option value="question">Question</option>
    <option value="error">Erreur</option>
    <option value="info">Info</option>
    <option value="other">Autre</option>
  </select><br>
  <button onclick="submitComment()">Envoyer</button>
  <button onclick="closeModal()">Annuler</button>
</div>

<script>
const url = "/uploads/{{ filename }}";
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = '/static/pdfjs/pdf.worker.min.js';

let pdfDoc = null, pageNum = 1, pageCount = 0, scale = 1.5;
let canvas = document.getElementById('pdf-canvas'), ctx = canvas.getContext('2d');
let clickX = 0, clickY = 0;
let commentsPerPage = {}; // Simuler un petit stockage temporaire

function renderPage(num) {
  pdfDoc.getPage(num).then(function(page) {
    let viewport = page.getViewport({ scale: scale });
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    let renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    page.render(renderContext);
    
    document.getElementById('page_num').textContent = pageNum;
    showCommentsForPage(num);
  });
}

function showCommentsForPage(page) {
  const list = document.getElementById('commentsList');
  list.innerHTML = '';
  const comments = commentsPerPage[page] || [];
  comments.forEach(comment => {
    const commentDiv = document.createElement('div');
    commentDiv.className = 'comment ' + comment.type;
    commentDiv.innerHTML = `[${comment.type}] ${comment.text} <button onclick="replyTo(this)">Répondre</button><div class="replies"></div>`;
    list.appendChild(commentDiv);
  });
}

function nextPage() {
  if (pageNum >= pageCount) return;
  pageNum++;
  renderPage(pageNum);
}

function prevPage() {
  if (pageNum <= 1) return;
  pageNum--;
  renderPage(pageNum);
}

function handleClick(event) {
  const rect = canvas.getBoundingClientRect();
  clickX = (event.clientX - rect.left) / rect.width;
  clickY = (event.clientY - rect.top) / rect.height;
  
  openModal();
}

function openModal() {
  document.getElementById('commentModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('commentModal').style.display = 'none';
}

function submitComment() {
  const text = document.getElementById('commentText').value;
  const type = document.getElementById('commentType').value;
  
  fetch("/add_comment", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: `page=${pageNum}&x=${clickX}&y=${clickY}&text=${encodeURIComponent(text)}&type=${type}`
  }).then(() => {
    if (!commentsPerPage[pageNum]) commentsPerPage[pageNum] = [];
    commentsPerPage[pageNum].push({ text: text, type: type, replies: [] });
    showCommentsForPage(pageNum);
    closeModal();
  });
}

function replyTo(button) {
  const replyText = prompt("Votre réponse :");
  if (!replyText) return;
  const replyDiv = document.createElement('div');
  replyDiv.className = 'reply';
  replyDiv.innerText = replyText;
  button.parentElement.querySelector('.replies').appendChild(replyDiv);
}

pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
  pdfDoc = pdfDoc_;
  pageCount = pdfDoc.numPages;
  document.getElementById('page_count').textContent = pageCount;
  renderPage(pageNum);
});
</script>
</body>
</html>
