<!DOCTYPE html>
<html>
<head>
  <title>Relecture PDF - MS Word Style</title>
  <style>
    body { display: flex; margin: 0; height: 100vh; font-family: Arial, sans-serif; }
    #viewerContainer { flex: 3; overflow: auto; position: relative; background: #f0f0f0; }
    #commentsPanel { flex: 1; border-left: 2px solid #ccc; padding: 10px; overflow-y: auto; background: #fafafa; }
    .controls { text-align: center; margin: 10px; }
    canvas { border: 1px solid #ccc; margin-bottom: 10px; }

    /* Comment block */
    .comment-block {
      border: 2px solid purple;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      background: white;
      position: relative;
      transition: background-color 0.5s;
    }
    .author-info {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .initials-circle {
      background-color: #6a1b9a;
      color: white;
      font-weight: bold;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      font-size: 14px;
    }
    .author-name {
      font-weight: bold;
      font-size: 14px;
    }
    .comment-text {
      margin: 8px 0;
      font-size: 14px;
    }
    .comment-date {
      font-size: 12px;
      color: gray;
      margin-bottom: 5px;
    }
    .comment-actions {
      position: absolute;
      top: 8px;
      right: 8px;
    }
    .comment-actions button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-left: 5px;
    }
    .reply-input {
      margin-top: 10px;
    }
    .reply-input input {
      width: 90%;
      padding: 5px;
      margin-top: 5px;
    }
    .highlight {
      animation: flash 1s ease-in-out;
      background-color: yellow;
    }
    @keyframes flash {
      0% { background-color: yellow; }
      100% { background-color: transparent; }
    }
    .fade-out {
      opacity: 0;
      transition: opacity 0.5s;
    }
    .marker {
      position: absolute;
      width: 24px;
      height: 24px;
      background: orange;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      cursor: pointer;
      transform: translate(-50%, -50%);
      z-index: 5;
      font-size: 14px;
      pointer-events: auto;
    }
    #markersContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
  </style>
  <script src="/static/pdfjs/pdf.min.js"></script>
</head>
<body>

<div id="viewerContainer">
  <div class="controls">
    <button onclick="prevPage()">‚¨ÖÔ∏è Pr√©c√©dent</button>
    <span>Page: <span id="page_num">1</span> / <span id="page_count">?</span></span>
    <button onclick="nextPage()">Suivant ‚û°Ô∏è</button>
  </div>
  <div style="position: relative;">
    <canvas id="pdf-canvas" onclick="handleClick(event)"></canvas>
    <div id="markersContainer"></div>
  </div>
</div>

<div id="commentsPanel">
  <h2>Commentaires</h2>
  <div id="commentsList"></div>
</div>

<!-- Modale pour ajouter un commentaire -->
<div id="commentModal" class="modal">
  <h3>Ajouter un commentaire</h3>
  <textarea id="commentText" placeholder="Votre commentaire" rows="4" cols="40"></textarea><br>
  <select id="commentType">
    <option value="suggestion">Suggestion</option>
    <option value="question">Question</option>
    <option value="error">Erreur</option>
    <option value="info">Info</option>
    <option value="other">Autre</option>
  </select><br>
  <button onclick="submitComment()">Envoyer</button>
  <button onclick="closeModal()">Annuler</button>
</div>

<script>
const url = "/uploads/{{ filename }}";
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = '/static/pdfjs/pdf.worker.min.js';

let pdfDoc = null, pageNum = 1, pageCount = 0, scale = 1.5;
let canvas = document.getElementById('pdf-canvas'), ctx = canvas.getContext('2d');
let clickX = 0, clickY = 0;
let commentsPerPage = {};  // {pageNum: [{author, text, type, x, y, replies:[], createdAt, status}]}

function renderPage(num) {
  pdfDoc.getPage(num).then(function(page) {
    let viewport = page.getViewport({ scale: scale });
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    let renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    page.render(renderContext);
    document.getElementById('page_num').textContent = pageNum;
    showCommentsForPage(num);
    drawMarkers();
  });
}

function nextPage() { if (pageNum < pageCount) { pageNum++; renderPage(pageNum); } }
function prevPage() { if (pageNum > 1) { pageNum--; renderPage(pageNum); } }

function handleClick(event) {
  const rect = canvas.getBoundingClientRect();
  clickX = (event.clientX - rect.left) / rect.width;
  clickY = (event.clientY - rect.top) / rect.height;
  openModal();
}

function openModal() {
  document.getElementById('commentText').value = '';
  document.getElementById('commentType').selectedIndex = 0;
  document.getElementById('commentModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('commentModal').style.display = 'none';
}

function submitComment() {
  const text = document.getElementById('commentText').value;
  const type = document.getElementById('commentType').value;
  const author = 'Christophe China'; // √† remplacer plus tard par l'identit√© utilisateur
  const initials = getInitials(author);
  const now = new Date().toLocaleString();

  fetch("/add_comment", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: `page=${pageNum}&x=${clickX}&y=${clickY}&text=${encodeURIComponent(text)}&type=${type}`
  }).then(() => {
    if (!commentsPerPage[pageNum]) commentsPerPage[pageNum] = [];
    commentsPerPage[pageNum].push({ text: text, type: type, x: clickX, y: clickY, author: author, initials: initials, createdAt: now, replies: [], status: 'open' });
    showCommentsForPage(pageNum);
    drawMarkers();
    closeModal();
  });
}

function showCommentsForPage(page) {
  const list = document.getElementById('commentsList');
  list.innerHTML = '';
  const comments = commentsPerPage[page] || [];
  comments.forEach((comment, index) => {
    const block = document.createElement('div');
    block.className = 'comment-block';
    block.id = `comment-${page}-${index}`;
    block.innerHTML = `
      <div class="author-info">
        <div class="initials-circle">${comment.initials}</div>
        <div class="author-name">${comment.author}</div>
      </div>
      <div class="comment-actions">
        <button onclick="editComment(${page}, ${index})">‚úèÔ∏è</button>
        <button onclick="resolveComment(${page}, ${index})">‚úÖ</button>
        <button onclick="deleteComment(${page}, ${index})">üóëÔ∏è</button>
      </div>
      <div class="comment-text">${comment.text}</div>
      <div class="comment-date">${comment.createdAt}</div>
    `;
    list.appendChild(block);
  });
}

function drawMarkers() {
  const container = document.getElementById('markersContainer');
  container.innerHTML = '';
  const comments = commentsPerPage[pageNum] || [];
  comments.forEach((comment, index) => {
    const marker = document.createElement('div');
    marker.className = 'marker';
    marker.textContent = index + 1;
    marker.title = comment.text.substring(0, 30) + '...';
    marker.style.left = (comment.x * canvas.width) + 'px';
    marker.style.top = (comment.y * canvas.height) + 'px';
    marker.onclick = function(event) {
      event.stopPropagation();
      const commentElement = document.getElementById(`comment-${pageNum}-${index}`);
      commentElement.scrollIntoView({ behavior: "smooth", block: "center" });
      commentElement.classList.add('highlight');
      setTimeout(() => {
        commentElement.classList.remove('highlight');
      }, 1500);
    };
    container.appendChild(marker);
  });
}

function editComment(page, index) {
  const comment = commentsPerPage[page][index];
  const newText = prompt("Modifier le commentaire :", comment.text);
  if (newText !== null) {
    comment.text = newText;
    showCommentsForPage(page);
    drawMarkers();
  }
}

function resolveComment(page, index) {
  alert('Fonction R√©soudre √† venir (peut changer le statut) ! üöÄ');
}

function deleteComment(page, index) {
  if (!confirm("Supprimer ce commentaire ?")) return;
  const block = document.getElementById(`comment-${page}-${index}`);
  block.classList.add('fade-out');
  setTimeout(() => {
    commentsPerPage[page].splice(index, 1);
    showCommentsForPage(page);
    drawMarkers();
  }, 500);
}

function getInitials(name) {
  const parts = name.split(' ');
  return (parts[0][0] + (parts[1]?.[0] || '')).toUpperCase();
}

pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
  pdfDoc = pdfDoc_;
  pageCount = pdfDoc.numPages;
  document.getElementById('page_count').textContent = pageCount;
  renderPage(pageNum);
});
</script>
</body>
</html>
