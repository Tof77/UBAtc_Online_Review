<!DOCTYPE html>
<html>
<head>
  <title>Relecture PDF - Multi Pages + Pastilles</title>
  <style>
    body { display: flex; margin: 0; height: 100vh; }
    #viewerContainer { flex: 3; overflow: auto; position: relative; background: #f0f0f0; position: relative; }
    #commentsPanel { flex: 1; border-left: 2px solid #ccc; padding: 10px; overflow-y: auto; background: #fafafa; }
    #commentsPanel h2 { font-size: 18px; margin-top: 0; }
    .comment { margin-bottom: 10px; background: #fff; padding: 5px; border-radius: 5px; position: relative; }
    .suggestion { border-left: 5px solid #42a5f5; }
    .question { border-left: 5px solid #1e88e5; }
    .error { border-left: 5px solid #e53935; }
    .info { border-left: 5px solid #43a047; }
    .other { border-left: 5px solid #9e9e9e; }
    .reply { margin-left: 20px; font-size: 90%; background: #eef; border-radius: 3px; padding: 3px; margin-top: 3px; }
    canvas { border: 1px solid #ccc; margin-bottom: 10px; }
    .controls { text-align: center; margin: 10px; }
    .modal {
      display: none; position: fixed; top: 30%; left: 50%;
      transform: translate(-50%, -30%);
      background: white; border: 2px solid #000; padding: 20px; z-index: 10;
    }
    .modal input, .modal select { margin: 5px 0; }
    #markersContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* important : bloque événements sauf pour pastilles */
    }    
    .marker {
      position: absolute;
      width: 24px;
      height: 24px;
      background: orange;
      border-radius: 50%;
      color: white;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      cursor: pointer;
      transform: translate(-50%, -50%);
      z-index: 5;
      font-size: 14px;
      pointer-events: auto; /* important : permet de cliquer/hover sur la pastille */
    }
    .highlight {
      animation: flash 1s ease-in-out;
      background-color: yellow;
    }
    
    @keyframes flash {
      0% { background-color: yellow; }
      100% { background-color: transparent; }
    }
    
  </style>
  <script src="/static/pdfjs/pdf.min.js"></script>
</head>
<body>
  <div id="viewerContainer">
    <div class="controls">
      <button onclick="prevPage()">⬅️ Précédent</button>
      <span>Page: <span id="page_num">1</span> / <span id="page_count">?</span></span>
      <button onclick="nextPage()">Suivant ➡️</button>
    </div>
    <div style="position: relative;">
      <canvas id="pdf-canvas" onclick="handleClick(event)"></canvas>
      <div id="markersContainer" style="position: absolute; top: 0; left: 0; pointer-events: none;"></div>
    </div>
  </div>

  <div id="commentsPanel">
    <h2>Commentaires</h2>
    <div id="commentsList"></div>
  </div>

<!-- Modale pour ajouter un commentaire -->
<div id="commentModal" class="modal">
  <h3>Ajouter un commentaire</h3>
  <textarea id="commentText" placeholder="Votre commentaire" rows="4" cols="40"></textarea><br>
  <select id="commentType">
    <option value="suggestion">Suggestion</option>
    <option value="question">Question</option>
    <option value="error">Erreur</option>
    <option value="info">Info</option>
    <option value="other">Autre</option>
  </select><br>
  <button onclick="submitComment()">Envoyer</button>
  <button onclick="closeModal()">Annuler</button>
</div>

<script>
const url = "/uploads/{{ filename }}";
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = '/static/pdfjs/pdf.worker.min.js';

let pdfDoc = null, pageNum = 1, pageCount = 0, scale = 1.5;
let canvas = document.getElementById('pdf-canvas'), ctx = canvas.getContext('2d');
let clickX = 0, clickY = 0;
let commentsPerPage = {};  // {pageNum: [{text, type, x, y, replies:[]}]}

function renderPage(num) {
  pdfDoc.getPage(num).then(function(page) {
    let viewport = page.getViewport({ scale: scale });
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    let renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    page.render(renderContext);

    document.getElementById('page_num').textContent = pageNum;
    showCommentsForPage(num);
    drawMarkers();
  });
}

function showCommentsForPage(page) {
  const list = document.getElementById('commentsList');
  list.innerHTML = '';
  const comments = commentsPerPage[page] || [];
  comments.forEach((comment, index) => {
    const commentDiv = document.createElement('div');
    commentDiv.id = `comment-${page}-${index}`;
    commentDiv.className = 'comment ' + comment.type;
    commentDiv.innerHTML = `<strong>[${comment.type}]</strong> ${comment.text} <button onclick="editComment(this)">Modifier</button><button onclick="deleteComment(this)">Supprimer</button> ${(comment.author !== 'anonymous') ? '' : '<button onclick="replyTo(this)">Répondre</button>'} <div class="replies"></div>`;
    comment.replies.forEach(reply => {
      const replyDiv = document.createElement('div');
      replyDiv.className = 'reply';
      replyDiv.innerText = reply;
      commentDiv.querySelector('.replies').appendChild(replyDiv);
    });
    list.appendChild(commentDiv);
  });
}

function drawMarkers() {
  const container = document.getElementById('markersContainer');
  container.innerHTML = '';
  const comments = commentsPerPage[pageNum] || [];
  comments.forEach((comment, index) => {
    const marker = document.createElement('div');
    marker.className = 'marker';
    marker.textContent = index + 1;
    marker.title = comment.text.substring(0, 30) + '...';
    marker.style.left = (comment.x * canvas.width) + 'px';
    marker.style.top = (comment.y * canvas.height) + 'px';
    marker.onclick = function(event) {
      event.stopPropagation();
      const commentElement = document.getElementById(`comment-${pageNum}-${index}`);
      commentElement.scrollIntoView({ behavior: "smooth", block: "center" });
      
      commentElement.classList.add('highlight');
      setTimeout(() => {
        commentElement.classList.remove('highlight');
      }, 1500); // 1,5 seconde après, on retire le flash
    };
    container.appendChild(marker);
  });
}

function nextPage() {
  if (pageNum >= pageCount) return;
  pageNum++;
  renderPage(pageNum);
}

function prevPage() {
  if (pageNum <= 1) return;
  pageNum--;
  renderPage(pageNum);
}

function handleClick(event) {
  const rect = canvas.getBoundingClientRect();
  clickX = (event.clientX - rect.left) / rect.width;
  clickY = (event.clientY - rect.top) / rect.height;
  
  openModal();
}

function openModal() {
  document.getElementById('commentText').value = '';  // vide le texte
  document.getElementById('commentType').selectedIndex = 0; // remet le premier choix
  document.getElementById('commentModal').style.display = 'block';
}


function closeModal() {
  document.getElementById('commentModal').style.display = 'none';
}

function submitComment() {
  const text = document.getElementById('commentText').value;
  const type = document.getElementById('commentType').value;

  fetch("/add_comment", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: `page=${pageNum}&x=${clickX}&y=${clickY}&text=${encodeURIComponent(text)}&type=${type}`
  }).then(() => {
    if (!commentsPerPage[pageNum]) commentsPerPage[pageNum] = [];
    commentsPerPage[pageNum].push({ text: text, type: type, x: clickX, y: clickY, replies: [] });
    showCommentsForPage(pageNum);
    drawMarkers();
    closeModal();
  });
}

function editComment(button) {
  const commentDiv = button.parentElement;
  const originalText = commentDiv.querySelector('strong').nextSibling.nodeValue.trim();
  const originalType = commentDiv.classList.contains('suggestion') ? 'suggestion'
                        : commentDiv.classList.contains('question') ? 'question'
                        : commentDiv.classList.contains('error') ? 'error'
                        : commentDiv.classList.contains('info') ? 'info'
                        : 'other';

  // Désactiver tous les boutons pendant édition
  document.querySelectorAll('button').forEach(b => b.disabled = true);

  const textarea = document.createElement('textarea');
  textarea.value = originalText;
  textarea.rows = 3;
  textarea.cols = 40;

  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Enregistrer';
  saveBtn.onclick = function() {
    const newText = textarea.value.trim();
    if (!newText) return;
    // Mettre à jour l'affichage
    commentDiv.innerHTML = `<strong>[${originalType}]</strong> ${newText} <button onclick="replyTo(this)">Répondre</button> <button onclick="editComment(this)">Modifier</button><div class="replies"></div>`;
    drawMarkers(); // redraw pastilles si nécessaire
    document.querySelectorAll('button').forEach(b => b.disabled = false);
  };

  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Annuler';
  cancelBtn.onclick = function() {
    // Recharger l'affichage sans changer
    commentDiv.innerHTML = `<strong>[${originalType}]</strong> ${originalText} <button onclick="replyTo(this)">Répondre</button> <button onclick="editComment(this)">Modifier</button><div class="replies"></div>`;
    document.querySelectorAll('button').forEach(b => b.disabled = false);
  };

  commentDiv.innerHTML = '';
  commentDiv.appendChild(textarea);
  commentDiv.appendChild(document.createElement('br'));
  commentDiv.appendChild(saveBtn);
  commentDiv.appendChild(cancelBtn);
}

function deleteComment(button) {
  if (!confirm('Supprimer ce commentaire ?')) return;
  const commentDiv = button.parentElement;
  commentDiv.remove();

  // TODO : plus tard quand on aura la sauvegarde JSON, il faudra aussi enlever du tableau `commentsPerPage`
}

function replyTo(button) {
  const replyText = prompt("Votre réponse :");
  if (!replyText) return;
  const replyDiv = document.createElement('div');
  replyDiv.className = 'reply';
  replyDiv.innerText = replyText;
  button.parentElement.querySelector('.replies').appendChild(replyDiv);
}

pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
  pdfDoc = pdfDoc_;
  pageCount = pdfDoc.numPages;
  document.getElementById('page_count').textContent = pageCount;
  renderPage(pageNum);
});
</script>
</body>
</html>
